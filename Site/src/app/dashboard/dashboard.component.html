<div class="min-h-screen bg-rd-background text-rd-primary">
  <header class="border-b border-[#ecd9a0]/70 bg-white/75 backdrop-blur">
    <div class="mx-auto flex max-w-6xl flex-col gap-6 px-6 py-6 lg:flex-row lg:items-center lg:justify-between lg:px-12">
      <div class="flex items-center gap-3">
        <a class="inline-flex items-center" routerLink="/">
          <img src="/images/van-brand.png" alt="RunDaddy brand logo" class="h-10 w-auto" />
        </a>
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.32em] text-rd-secondary">RunDaddy</p>
          <p class="text-lg font-semibold text-rd-primary">Operations Control</p>
        </div>
      </div>
      <div class="flex flex-col items-stretch gap-4 sm:flex-row sm:items-center sm:justify-end sm:gap-6">
        <nav class="flex flex-wrap items-center gap-2">
          <a
            *ngFor="let tab of tabs"
            [routerLink]="tab.route"
            routerLinkActive="active"
            [routerLinkActiveOptions]="{ exact: true }"
            #rla="routerLinkActive"
            [class]="[
              'rounded-full px-5 py-2 text-sm font-semibold transition',
              rla.isActive
                ? 'bg-rd-accent text-rd-primary shadow-[0_18px_32px_-26px_rgba(231,150,7,0.55)] hover:bg-rd-accent-strong hover:text-white'
                : 'bg-white/60 text-rd-secondary hover:bg-white hover:text-rd-primary'
            ].join(' ')"
            [attr.aria-current]="rla.isActive ? 'page' : null"
          >
            {{ tab.label }}
          </a>
        </nav>
        <div
          *ngIf="showCompanySelector()"
          class="flex flex-col gap-2 text-xs text-rd-secondary sm:items-end sm:text-right"
        >
          <div class="flex w-full justify-end sm:w-auto">
            <button
              type="button"
              class="inline-flex items-center justify-center gap-2 rounded-full border border-rd-primary/12 bg-white/80 px-4 py-2 text-sm font-semibold text-rd-primary shadow-sm transition hover:border-rd-accent hover:bg-white disabled:cursor-not-allowed disabled:opacity-60"
              (click)="openCompanyModal()"
              [disabled]="isSwitchingCompany() || loadingMemberships()"
            >
              <svg
                *ngIf="!isSwitchingCompany(); else switchingSpinner"
                class="h-4 w-4"
                viewBox="0 0 24 24"
                fill="none"
                role="presentation"
              >
                <path
                  d="M5 12h14m-4-4 4 4-4 4"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Switch context
            </button>
            <ng-template #switchingSpinner>
              <svg
                class="h-4 w-4 animate-spin text-rd-primary"
                viewBox="0 0 24 24"
                fill="none"
                role="presentation"
              >
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v3a5 5 0 0 0-5 5H4z"></path>
              </svg>
            </ng-template>
          </div>
          <div
            *ngIf="companySwitchError()"
            class="flex flex-wrap items-center gap-2 text-xs text-[#f87171]"
          >
            <span>{{ companySwitchError() }}</span>
            <button
              type="button"
              class="text-xs font-semibold text-rd-accent transition hover:text-rd-accent-strong disabled:opacity-60"
              (click)="reloadMemberships()"
              [disabled]="loadingMemberships()"
            >
              Retry
            </button>
          </div>
        </div>
        <div
          class="flex items-center gap-3 rounded-full border border-rd-primary/12 bg-white/70 px-4 py-2 text-sm text-rd-secondary shadow-sm"
        >
          <span class="font-semibold text-rd-primary">
            {{ user()?.firstName ? user()?.firstName + ' ' + (user()?.lastName ?? '') : '—' }}
          </span>
          <span class="hidden text-xs text-rd-secondary sm:inline">
            • {{ company()?.name || '—' }}
          </span>
          <button
            type="button"
            (click)="logout()"
            class="rounded-full border border-rd-primary/12 px-3 py-1 text-xs font-semibold text-rd-primary transition hover:border-rd-accent hover:bg-white"
          >
            Log out
          </button>
        </div>
      </div>
    </div>
  </header>

  <div *ngIf="companyModalOpen()" class="fixed inset-0 z-50 flex items-center justify-center px-4 py-10" role="dialog" aria-modal="true" aria-labelledby="company-modal-title">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" (click)="closeCompanyModal()"></div>
    <div
      class="relative z-10 w-full max-w-md rounded-3xl border border-rd-primary/12 bg-white/95 p-6 text-left shadow-[0_24px_48px_-24px_rgba(32,29,20,0.35)]"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 id="company-modal-title" class="text-xl font-semibold text-rd-primary">Switch company</h2>
          <p class="mt-1 text-sm text-rd-secondary">
            Choose the company context you want to manage.
          </p>
        </div>
        <button
          type="button"
          class="rounded-full border border-rd-primary/10 bg-white/70 p-2 text-rd-secondary transition hover:text-rd-primary disabled:opacity-60"
          (click)="closeCompanyModal()"
          [disabled]="isSwitchingCompany()"
          aria-label="Close"
        >
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" role="presentation">
            <path
              d="M6 6l12 12M6 18 18 6"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>

      <div class="mt-6 space-y-3">
        <div *ngIf="loadingMemberships()" class="space-y-2">
          <div class="h-12 animate-pulse rounded-2xl bg-rd-primary/10"></div>
          <div class="h-12 animate-pulse rounded-2xl bg-rd-primary/10"></div>
        </div>

        <div *ngIf="!loadingMemberships() && memberships().length">
          <ul class="space-y-2">
            <li *ngFor="let membership of memberships()">
              <button
                type="button"
                class="group flex w-full items-center justify-between gap-3 rounded-2xl border border-transparent bg-white/80 px-4 py-3 text-left text-sm transition hover:border-rd-accent hover:bg-rd-accent/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rd-accent/40 disabled:opacity-60"
                (click)="selectCompany(membership.companyId)"
                [disabled]="isSwitchingCompany()"
              >
                <div>
                  <p class="font-semibold text-rd-primary">{{ membership.companyName }}</p>
                  <p class="mt-1 text-[11px] font-medium uppercase tracking-[0.28em] text-rd-muted">
                    {{ membership.role | titlecase }}
                  </p>
                </div>
                <div class="flex items-center gap-2">
                  <span
                    *ngIf="membership.companyId === company()?.id; else switchLabel"
                    class="inline-flex items-center gap-2 rounded-full bg-rd-accent/20 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.18em] text-rd-accent"
                  >
                    <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" role="presentation">
                      <path
                        d="M6 12.6 9.6 16l8.4-8.4"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                    Active
                  </span>
                  <ng-template #switchLabel>
                    <span
                      class="inline-flex items-center gap-1 text-xs font-semibold uppercase tracking-[0.24em] text-rd-secondary transition group-hover:text-rd-accent"
                    >
                      Switch
                      <svg
                        class="h-3 w-3"
                        viewBox="0 0 24 24"
                        fill="none"
                        role="presentation"
                      >
                        <path
                          d="M9 6l6 6-6 6"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                    </span>
                  </ng-template>
                </div>
              </button>
            </li>
          </ul>
        </div>

        <div
          *ngIf="!loadingMemberships() && !memberships().length"
          class="rounded-2xl border border-rd-primary/12 bg-rd-background/70 px-4 py-4 text-sm text-rd-muted"
        >
          <p>No other companies available.</p>
        </div>
      </div>
    </div>
  </div>

  <main class="mx-auto max-w-6xl px-6 py-10 lg:px-12">
    <router-outlet />
  </main>
</div>
