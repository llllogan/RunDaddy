<div class="min-h-screen bg-rd-background text-rd-primary">
  <header class="border-b border-[#ecd9a0]/70 bg-white/75 backdrop-blur">
    <div class="mx-auto flex max-w-6xl flex-col gap-6 px-6 py-6 lg:flex-row lg:items-center lg:justify-between lg:px-12">
      <div class="flex items-center gap-3">
        <span class="flex h-10 w-10 items-center justify-center rounded-xl bg-rd-accent/20 text-lg font-semibold text-rd-accent">RD</span>
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.32em] text-rd-secondary">RunDaddy</p>
          <p class="text-lg font-semibold text-rd-primary">Operations Control</p>
        </div>
      </div>
      <div class="flex flex-col items-stretch gap-4 sm:flex-row sm:items-center sm:justify-end sm:gap-6">
        <nav class="flex flex-wrap items-center gap-2">
          <button
            *ngFor="let tab of tabs"
            type="button"
            (click)="setTab(tab.id)"
            [class]="[
              'rounded-full px-5 py-2 text-sm font-semibold transition',
              activeTab() === tab.id
                ? 'bg-rd-accent text-rd-primary shadow-[0_18px_32px_-26px_rgba(231,150,7,0.55)] hover:bg-rd-accent-strong hover:text-white'
                : 'bg-white/60 text-rd-secondary hover:bg-white hover:text-rd-primary'
            ].join(' ')"
          >
            {{ tab.label }}
          </button>
        </nav>
        <div
          *ngIf="showCompanySelector()"
          class="flex flex-col gap-2 text-xs text-rd-secondary sm:items-end sm:text-right"
        >
          <span class="font-semibold uppercase tracking-[0.2em] text-rd-secondary">Company</span>
          <div class="relative w-full sm:w-56">
            <select
              class="w-full rounded-full border border-rd-primary/15 bg-white px-4 py-2 text-sm font-semibold text-rd-primary outline-none transition focus:border-rd-accent focus:ring-2 focus:ring-rd-accent/30 disabled:cursor-not-allowed disabled:opacity-60"
              [value]="company()?.id ?? ''"
              (change)="onCompanyChange($event)"
              [disabled]="isSwitchingCompany() || loadingMemberships() || memberships().length <= 1"
            >
              <option *ngIf="loadingMemberships()" value="" disabled>Loading companies…</option>
              <option
                *ngIf="!loadingMemberships() && !memberships().length"
                [value]="company()?.id ?? ''"
              >
                {{ company()?.name || 'Current company' }}
              </option>
              <option *ngFor="let membership of memberships()" [value]="membership.companyId">
                {{ membership.companyName }}
              </option>
            </select>
            <svg
              *ngIf="isSwitchingCompany()"
              class="pointer-events-none absolute right-3 top-1/2 h-4 w-4 -translate-y-1/2 animate-spin text-rd-accent"
              viewBox="0 0 24 24"
              fill="none"
              role="presentation"
            >
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v3a5 5 0 0 0-5 5H4z"></path>
            </svg>
          </div>
          <div
            *ngIf="companySwitchError()"
            class="flex flex-wrap items-center gap-2 text-xs text-[#f87171]"
          >
            <span>{{ companySwitchError() }}</span>
            <button
              type="button"
              class="text-xs font-semibold text-rd-accent transition hover:text-rd-accent-strong disabled:opacity-60"
              (click)="reloadMemberships()"
              [disabled]="loadingMemberships()"
            >
              Retry
            </button>
          </div>
        </div>
        <div
          class="flex items-center gap-3 rounded-full border border-rd-primary/12 bg-white/70 px-4 py-2 text-sm text-rd-secondary shadow-sm"
        >
          <span class="font-semibold text-rd-primary">
            {{ user()?.firstName ? user()?.firstName + ' ' + (user()?.lastName ?? '') : '—' }}
          </span>
          <span class="hidden text-xs text-rd-secondary sm:inline">
            • {{ company()?.name || '—' }}
          </span>
          <button
            type="button"
            (click)="logout()"
            class="rounded-full border border-rd-primary/12 px-3 py-1 text-xs font-semibold text-rd-primary transition hover:border-rd-accent hover:bg-white"
          >
            Log out
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-6 py-10 lg:px-12">
    <section *ngIf="activeTab() === 'home'" class="space-y-10">
      <article
        class="flex w-full flex-col justify-between rounded-3xl border border-rd-primary/12 bg-white/90 p-8 shadow-rd-card transition-colors"
        (drop)="onDrop($event)"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
      >
        <div>
          <h2 class="text-2xl font-semibold text-rd-primary">Upload pick list</h2>
          <p class="mt-3 text-sm leading-6 text-rd-secondary">
            Drag & drop a spreadsheet exported from your warehouse system. RunDaddy parses SKUs, builds picker routes,
            and schedules vending bins automatically.
          </p>
          <div
            class="mt-8 flex flex-1 flex-col items-center justify-center rounded-2xl border border-dashed transition"
            [class]="[
              'border-rd-primary/20 bg-white/80 px-6 py-12 text-center',
              isDragging() ? 'border-rd-accent/70 bg-rd-accent/10' : ''
            ].join(' ')"
          >
            <p class="mt-5 text-sm font-medium text-rd-primary">
              Drop your Excel or CSV file here
            </p>
            <p class="mt-2 text-xs text-rd-muted">Supports .xlsx and .xls</p>
            <label
              class="mt-6 inline-flex cursor-pointer items-center rounded-full bg-rd-accent px-5 py-2 text-sm font-semibold text-rd-primary shadow-[0_16px_32px_-24px_rgba(231,150,7,0.55)] transition hover:scale-[1.02] hover:bg-rd-accent-strong hover:text-white"
            >
              <input type="file" accept=".xlsx,.xls,.csv" class="hidden" (change)="onFileSelect($event)" multiple />
              Browse files
            </label>
          </div>
        </div>
        <div *ngIf="hasFiles()" class="mt-10 space-y-4">
          <h3 class="text-sm font-semibold text-rd-primary">Recent uploads</h3>
          <ul class="space-y-3">
            <li
              *ngFor="let upload of uploadedFiles()"
              class="space-y-3 rounded-xl border border-rd-primary/12 bg-white/80 px-4 py-4"
            >
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <p class="text-sm font-medium text-rd-primary">{{ upload.file.name }}</p>
                  <p class="text-xs text-rd-muted">
                    {{ formatFileSize(upload.file.size) }} · Received {{ upload.receivedAt | date : 'shortTime' }}
                  </p>
                </div>
                <div class="flex items-center gap-3">
                  <span
                    [class]="[
                      'inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold',
                      uploadStatusClass(upload.status)
                    ].join(' ')"
                  >
                    <svg
                      *ngIf="upload.status === 'uploading'"
                      class="h-3.5 w-3.5 animate-spin text-current"
                      viewBox="0 0 24 24"
                      fill="none"
                      role="presentation"
                    >
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v3a5 5 0 0 0-5 5H4z"></path>
                    </svg>
                    {{ uploadStatusLabel(upload.status) }}
                  </span>
                  <button
                    type="button"
                    (click)="removeFile(upload.id)"
                    class="rounded-full border border-rd-primary/12 px-3 py-1 text-xs font-semibold text-rd-secondary transition hover:border-rd-accent hover:text-rd-primary"
                  >
                    Remove
                  </button>
                </div>
              </div>

              <div
                *ngIf="upload.status === 'error' && upload.error"
                class="flex flex-wrap items-center gap-2 rounded-lg border border-[#f87171]/30 bg-[#f87171]/10 px-3 py-2 text-xs text-[#f87171]"
              >
                <span>{{ upload.error }}</span>
                <button
                  type="button"
                  class="rounded-full border border-[#f87171]/40 px-3 py-1 text-xs font-semibold text-[#f87171] transition hover:border-[#f87171]/60 hover:text-[#c24141]"
                  (click)="retryUpload(upload.id)"
                >
                  Retry upload
                </button>
              </div>

              <div *ngIf="upload.result" class="space-y-3 rounded-lg border border-rd-primary/12 bg-white/80 px-3 py-3 text-xs text-rd-secondary">
                <div class="flex flex-wrap items-center gap-3 text-sm text-rd-primary">
                  <span class="font-semibold text-rd-secondary">Summary</span>
                  <span class="rounded-full border border-rd-primary/12 px-2.5 py-1 text-xs text-rd-primary/80">
                    Runs: {{ upload.result.summary.runs }}
                  </span>
                  <span class="rounded-full border border-rd-primary/12 px-2.5 py-1 text-xs text-rd-primary/80">
                    Machines: {{ upload.result.summary.machines }}
                  </span>
                  <span class="rounded-full border border-rd-primary/12 px-2.5 py-1 text-xs text-rd-primary/80">
                    Pick entries: {{ upload.result.summary.pickEntries }}
                  </span>
                </div>
                <details class="rounded-lg border border-rd-primary/12 bg-white/85 px-3 py-2">
                  <summary class="cursor-pointer text-xs font-semibold text-rd-accent outline-none">View workbook JSON</summary>
                  <pre class="mt-2 max-h-64 overflow-auto whitespace-pre-wrap text-[11px] leading-relaxed text-rd-muted">{{ upload.result.workbook | json }}</pre>
                </details>
              </div>
            </li>
          </ul>
        </div>
      </article>
    </section>

    <section *ngIf="activeTab() === 'users'" class="space-y-8">
      <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-2xl font-semibold text-rd-primary">Team directory</h2>
          <p class="text-sm text-rd-secondary">Every user who belongs to this company and has access to RunDaddy.</p>
        </div>
      </header>

      <div class="rounded-3xl border border-rd-primary/12 bg-white/90 p-6 shadow-rd-card">
        <div
          *ngIf="usersError()"
          class="mb-4 flex flex-wrap items-center gap-2 rounded-2xl border border-[#f87171]/30 bg-[#f87171]/10 px-4 py-3 text-xs text-[#f87171]"
        >
          <span>{{ usersError() }}</span>
          <button
            type="button"
            class="text-xs font-semibold text-rd-accent transition hover:text-rd-accent-strong disabled:opacity-60"
            (click)="reloadUsers()"
            [disabled]="loadingUsers()"
          >
            Retry
          </button>
        </div>

        <div *ngIf="loadingUsers(); else usersContent" class="flex items-center justify-center py-10 text-sm text-rd-secondary">
          Loading users…
        </div>

        <ng-template #usersContent>
          <div *ngIf="hasUsers(); else usersEmpty">
            <table class="min-w-full text-left text-sm text-rd-secondary">
              <thead>
                <tr class="text-xs uppercase tracking-wide text-rd-muted">
                  <th class="pb-4 font-semibold">Name</th>
                  <th class="pb-4 font-semibold">Email</th>
                  <th class="pb-4 font-semibold">Role</th>
                  <th class="pb-4 font-semibold">Phone</th>
                  <th class="pb-4 font-semibold">Added</th>
                  <th class="pb-4 font-semibold">Updated</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-[#ecd9a0]/60 text-sm">
                <tr *ngFor="let member of users(); trackBy: trackByUser" class="hover:bg-white">
                  <td class="py-3 text-rd-primary">{{ formatUserName(member) }}</td>
                  <td class="py-3 text-rd-secondary">{{ member.email }}</td>
                  <td class="py-3">
                    <span class="inline-flex items-center rounded-full border border-rd-primary/12 bg-white/80 px-3 py-1 text-xs font-semibold text-rd-primary">
                      {{ formatRole(member.role) }}
                    </span>
                  </td>
                  <td class="py-3 text-rd-primary">{{ member.phone || '—' }}</td>
                  <td class="py-3">{{ member.createdAt | date : 'MMM d, y' }}</td>
                  <td class="py-3">{{ member.updatedAt | date : 'MMM d, y, h:mm a' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-template>

        <ng-template #usersEmpty>
          <div class="rounded-2xl border border-rd-primary/12 bg-white/80 px-6 py-8 text-sm text-rd-secondary">
            No users found for this company yet.
          </div>
        </ng-template>
      </div>
    </section>

    <section *ngIf="activeTab() === 'runs'" class="space-y-8">
      <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-2xl font-semibold text-rd-primary">Recent runs</h2>
          <p class="text-sm text-rd-secondary">Live snapshot from the last 24 hours of warehouse activity.</p>
        </div>
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-full border border-rd-primary/12 bg-white/70 px-4 py-2 text-xs font-semibold text-rd-secondary transition hover:bg-white hover:text-rd-primary"
        >
          Export report
        </button>
      </header>

      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-2xl border border-rd-primary/12 bg-white/90 p-5 shadow-rd-card">
          <p class="text-xs text-rd-secondary">Average route duration</p>
          <p class="mt-3 text-2xl font-semibold text-rd-primary">41m</p>
          <p class="mt-1 text-xs text-rd-teal">14% faster than last week</p>
        </div>
        <div class="rounded-2xl border border-rd-primary/12 bg-white/90 p-5 shadow-rd-card">
          <p class="text-xs text-rd-secondary">Voice confirmations</p>
          <p class="mt-3 text-2xl font-semibold text-rd-primary">98.7%</p>
          <p class="mt-1 text-xs text-rd-secondary">5,214 verbal check-ins recorded</p>
        </div>
        <div class="rounded-2xl border border-rd-primary/12 bg-white/90 p-5 shadow-rd-card">
          <p class="text-xs text-rd-secondary">High priority bins</p>
          <p class="mt-3 text-2xl font-semibold text-rd-primary">12</p>
          <p class="mt-1 text-xs text-[#f9c74f]">Monitor restock this afternoon</p>
        </div>
        <div class="rounded-2xl border border-rd-primary/12 bg-white/90 p-5 shadow-rd-card">
          <p class="text-xs text-rd-secondary">Picker coverage</p>
          <p class="mt-3 text-2xl font-semibold text-rd-primary">7 / 8</p>
          <p class="mt-1 text-xs text-rd-secondary">One PTO · coverage holding</p>
        </div>
      </div>

      <div class="rounded-3xl border border-rd-primary/12 bg-white/90 p-6 shadow-rd-card">
        <div
          *ngIf="runsError()"
          class="mb-4 flex flex-wrap items-center gap-2 rounded-2xl border border-[#f87171]/30 bg-[#f87171]/10 px-4 py-3 text-xs text-[#f87171]"
        >
          <span>{{ runsError() }}</span>
          <button
            type="button"
            class="text-xs font-semibold text-rd-accent transition hover:text-rd-accent-strong disabled:opacity-60"
            (click)="reloadRuns()"
            [disabled]="loadingRuns()"
          >
            Retry
          </button>
        </div>

        <div *ngIf="loadingRuns(); else runsContent" class="flex items-center justify-center py-10 text-sm text-rd-secondary">
          Loading recent runs…
        </div>

        <ng-template #runsContent>
          <div *ngIf="hasRuns(); else runsEmpty">
            <table class="min-w-full text-left text-sm text-rd-secondary">
              <thead>
                <tr class="text-xs uppercase tracking-wide text-rd-muted">
                  <th class="pb-4 font-semibold">Run</th>
                  <th class="pb-4 font-semibold">Status</th>
                  <th class="pb-4 font-semibold">Picker</th>
                  <th class="pb-4 font-semibold">Runner</th>
                  <th class="pb-4 font-semibold">Scheduled</th>
                  <th class="pb-4 font-semibold">Updated</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-[#ecd9a0]/60 text-sm">
                <tr *ngFor="let run of runs(); trackBy: trackByRun" class="hover:bg-white">
                  <td class="py-3 font-mono text-xs uppercase tracking-wider text-rd-secondary">
                    #{{ run.id | slice:-6 }}
                  </td>
                  <td class="py-3">
                    <span
                      [class]="[
                        'inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold',
                        statusBadgeClass(run.status)
                      ].join(' ')"
                    >
                      {{ formatStatus(run.status) }}
                    </span>
                  </td>
                  <td class="py-3 text-rd-primary">{{ formatPerson(run.picker) }}</td>
                  <td class="py-3 text-rd-primary">{{ formatPerson(run.runner) }}</td>
                  <td class="py-3">
                    {{ run.scheduledFor ? (run.scheduledFor | date : 'MMM d, h:mm a') : '—' }}
                  </td>
                  <td class="py-3">
                    {{ getRunUpdatedAt(run) | date : 'MMM d, h:mm a' }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-template>

        <ng-template #runsEmpty>
          <div class="rounded-2xl border border-rd-primary/12 bg-white/80 px-6 py-8 text-sm text-rd-secondary">
            No runs recorded for this company yet. Upload a pick list to get started.
          </div>
        </ng-template>
      </div>
    </section>
  </main>
</div>
